# Predefined Plans Implementation Progress

## Phase 1: Routing Structure
- [x] Create `/plan/[planId]/page.tsx` route
- [x] Create `/plan/page.tsx` for new plans
- [x] Modify `/page.tsx` to show welcome screen
- [x] Update sidebar navigation links

## Phase 2: Predefined Plans Data
- [x] Create `src/data/predefined-plans.ts`
- [x] Define BAU plan with rules and criteria
- [x] Define NSP 2026-30 plan with rules and criteria
- [x] Map interventions to correct IDs

## Phase 3: Plan Loading
- [x] Load plan definition based on route parameter
- [x] Initialize rules state from plan definition
- [x] Connect to existing map/list/budget views
- [x] Handle invalid plan IDs

## Phase 4: Welcome Screen
- [x] Design and implement welcome screen UI
- [x] Add appropriate messaging and guidance
- [x] Ensure responsive layout

## Phase 5: Integration Testing
- [x] Verify all plans load correctly
- [x] Test intervention assignments match specifications
- [x] Validate criteria matching logic
- [x] Test navigation flows

---

## Notes

- Intervention IDs mapped from cost-data.ts and page.tsx comments:
  - CM (Case Management) - Category 37, Intervention 78
  - SMC - Category 38, Intervention 80
  - PMC - Category 38, Intervention 81
  - Standard Pyrethroid Campaign - Category 40, Intervention 85
  - Dual AI Campaign - Category 40, Intervention 87
  - Standard Pyrethroid Routine - Category 41, Intervention 88
  - Dual AI Routine - Category 41, Intervention 90
- Metric Type IDs:
  - Seasonality: 413
  - Mortality rate: 407
  - Incidence rate: 410
  - Insecticide resistance: 412
- R21 (Vaccine) is mentioned in PRD but not available in current intervention categories - omitted

---

## Completed Tasks

- [2026-01-28] Phase 1.1: Create `/plan/[planId]/page.tsx` route
  - Created dynamic route that loads predefined plans by ID
  - Supports plan viewing with full map/list/budget views
  - Shows "Plan Not Found" error for invalid plan IDs
- [2026-01-28] Phase 2: Predefined Plans Data
  - Created `src/data/predefined-plans.ts` with BAU and NSP 2026-30 plans
  - Mapped all criteria to metric type IDs
  - Mapped all interventions to category/intervention IDs
- [2026-01-28] Phase 3: Plan Loading
  - Implemented plan loading from route parameter
  - Rules are initialized from plan definition on component mount
  - Existing map/list/budget views work unchanged
  - Invalid plan IDs show error message
- [2026-01-28] Phase 1.2: Create `/plan/page.tsx` for new plans
  - Created new plan page at `/plan` route
  - Initializes with default rule (CM + Standard Pyrethroid Campaign/Routine)
  - Uses `getDefaultRulesForNewPlan()` from predefined-plans.ts
  - Full map/list/budget views work, rules can be added/edited
- [2026-01-28] Phase 1.3 & Phase 4: Implement welcome screen at root route
  - Replaced full intervention map UI at `/page.tsx` with welcome screen
  - Title: "SNT Intervention Planning Tool"
  - Description explains the tool's purpose (plan malaria interventions, define rules, view coverage, analyze budget)
  - Guidance directs users to select a plan from sidebar or create new
  - Responsive centered layout with appropriate typography
  - Sidebar remains accessible via SidebarTrigger
- [2026-01-28] Phase 1.4: Update sidebar navigation links
  - Clicking "BAU" now navigates to `/plan/bau`
  - Clicking "NSP 2026-30" now navigates to `/plan/nsp-2026-30`
  - Clicking "New plan" now navigates to `/plan` (removed dialog)
  - Active plan is now determined from URL pathname instead of local state
  - "New plan" shows active state when at `/plan` route
  - Plans list is now dynamically loaded from PREDEFINED_PLANS constant
  - Removed unused Dialog, Button, Input component imports and useState hooks
- [2026-01-28] Phase 5.1: Verify all plans load correctly
  - Build passes with type checking and linting
  - All routes compiled successfully: `/` (welcome), `/plan` (new plan), `/plan/[planId]` (predefined plans)
  - `getPlanById()` function correctly retrieves BAU and NSP 2026-30 plans
  - Invalid plan IDs display "Plan Not Found" error message
  - No TypeScript or ESLint errors
- [2026-01-28] Phase 5.2: Test intervention assignments match specifications
  - Verified NSP 2026-30 plan interventions match PRD:
    - Rule 1 (High Seasonality, High Mortality): Dual AI Campaign, Dual AI Routine, SMC, CM
    - Rule 2 (Low Season, High Inc, High Mort, High Res): Dual AI Campaign, Dual AI Routine, PMC, CM
    - Rule 3 (Low Season, High Inc, Low Mort, High Res): Dual AI Campaign, Dual AI Routine, PMC, CM
    - Default: Standard Pyrethroid Campaign, Standard Pyrethroid Routine, CM
  - Verified BAU plan interventions match PRD:
    - Rule 1 (Low Season, High Inc, Low Mort, High Res): Dual AI Campaign, Dual AI Routine, PMC, CM
    - Default: Standard Pyrethroid Campaign, Standard Pyrethroid Routine, CM
  - Verified all criteria values match PRD specifications
  - R21 (Vaccine) correctly omitted as not available in intervention categories
  - Build passes with no TypeScript or ESLint errors
- [2026-01-28] Phase 5.3: Validate criteria matching logic
  - Created validation script at `scripts/validate-criteria-matching.ts`
  - Tested `evaluateRule()` function with all 5 operators (<, <=, =, >=, >)
  - Verified decimal value comparisons work correctly (important for seasonality thresholds)
  - Validated predefined plan structure matches PRD specifications:
    - BAU plan: 2 rules (1 criteria-based + 1 default), correct criteria values
    - NSP 2026-30 plan: 4 rules (3 criteria-based + 1 default), correct criteria values
  - Tested district matching scenarios with simulated metric values:
    - NSP Rule 1 matches districts with seasonality >= 0.6 AND mortality >= 5
    - NSP Rule 2 matches districts with seasonality < 0.6, incidence >= 300, mortality >= 5, resistance >= 0.75
    - NSP Rule 3 matches districts with seasonality < 0.6, incidence >= 300, mortality < 5, resistance >= 0.75
    - BAU Rule 1 matches districts with seasonality < 0.7, incidence >= 500, mortality < 10, resistance >= 0.75
  - Verified boundary value handling (e.g., seasonality=0.6 matches >= 0.6 but not < 0.6)
  - All 77 validation tests passed
  - Build passes with no TypeScript or ESLint errors
- [2026-01-28] Phase 5.4: Test navigation flows
  - Created validation script at `scripts/validate-navigation-flows.ts`
  - Tested route structure:
    - Root route `/` displays welcome screen
    - `/plan` route shows new plan as active
    - `/plan/[planId]` routes extract correct plan ID
  - Tested sidebar link generation for all predefined plans
  - Tested active state detection:
    - Each plan route correctly activates only its own plan in sidebar
    - Settings routes (/layers, /cost-settings, /composite-scores) have no active plan
    - Footer routes (/help, /feedback, /account) properly detected
    - Action routes (/search, /compare) properly detected
  - Tested invalid plan ID handling (getPlanById returns undefined)
  - Tested pathname parsing edge cases (nested routes, trailing slashes)
  - Tested navigation flow scenarios:
    - Welcome screen → BAU plan
    - BAU plan → New plan
    - New plan → NSP 2026-30
    - NSP plan → Welcome screen (via header logo)
  - Verified all expected sidebar links are parseable
  - All 56 navigation tests passed
  - Build passes with no TypeScript or ESLint errors
