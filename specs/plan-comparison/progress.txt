# Plan Comparison Feature - Implementation Progress

## Phase 1: Sidebar Infrastructure
- [x] Create comparison-sidebar component structure
- [x] Implement toggle button ("Compare...") in plan editor toolbar
- [x] Position toggle button right of "Export plan" button
- [x] Set up sidebar open/close state management
- [x] Integrate sidebar as sibling to intervention map in page layout
- [x] Style sidebar container (width, border, background)

## Phase 2: Plan Cards
- [x] Create plan-comparison-card component
- [x] Display all predefined plans (BAU, NSP 2026-30)
- [x] Style card layout (title area, map placeholder)
- [x] Add scrollable container for plan list

## Phase 3: Edit Detection
- [x] Implement original plan storage when loading a plan
- [x] Create comparison logic (original vs current plan)
- [x] Add "Edited" badge component
- [x] Connect badge visibility to edit state
- [x] Verify badge updates in real-time on changes

## Phase 4: Miniature Maps
- [x] Create miniature-map component
- [x] Reuse intervention calculation logic from main map
- [x] Render district boundaries correctly
- [x] Apply correct intervention colors
- [x] Ensure maps are non-interactive (no hover, no click)
- [x] Optimize rendering for multiple map instances

## Phase 5: Polish & Integration
- [x] Add slide animation for sidebar open/close
- [x] Ensure responsive behavior
- [ ] Performance optimization
- [ ] Test with all plan combinations

---

## Notes

- Sidebar component location: src/components/comparison-sidebar/
- Sidebar is a sibling to intervention-map, not nested within it
- Miniature maps always show original plan state, not edited version

---

## Progress Log

### 2026-01-28: Created comparison-sidebar component structure

- Created `src/components/comparison-sidebar/` directory
- Created `comparison-sidebar.tsx` with:
  - `ComparisonSidebar` component with header ("Compare with") and close button
  - `PlanComparisonCard` component with plan title, "Edited" badge, and map placeholder
  - Props for `isOpen`, `onClose`, `currentPlanId`, and `isEdited`
  - Scrollable container for plan list
  - Ring highlight for current plan card
  - Amber badge styling for "Edited" state
- Created `index.ts` for exports
- All TypeScript and ESLint checks pass

### 2026-01-28: Implemented toggle button and sidebar integration

- Added "Compare..." button to plan page header, positioned to the right of "Export Plan" button
- Button toggles between `outline` (inactive) and `secondary` (active) variants
- Added `isComparisonOpen` state to manage sidebar visibility
- Integrated `ComparisonSidebar` component as sibling to main content in the `<main>` element
- Sidebar slides in from the right when toggled open
- All TypeScript and ESLint checks pass

### 2026-01-28: Implemented edit detection for plan comparison

- Added `originalRules` state to store the original plan rules when loading
- Created `serializeRule()` helper function to serialize SavedRule objects (handles Map objects properly)
- Created `areRulesEqual()` function to deep-compare two arrays of SavedRules
- Added `isEdited` computed value using useMemo to compare current rules vs original
- Updated initialization effect to store both `savedRules` and `originalRules` on plan load
- Connected `isEdited` prop to ComparisonSidebar (previously hardcoded to `false`)
- "Edited" badge now displays dynamically when the current plan differs from its original state
- All TypeScript and ESLint checks pass, build succeeds

### 2026-01-28: Created miniature map component for plan comparison

- Created `src/components/comparison-sidebar/miniature-map.tsx` with:
  - `MiniatureMap` component that renders a static MapLibre map for a given plan
  - `MiniatureDistrictLayer` inner component for rendering fill + border layers
  - `applyPlanRules()` function that computes colored GeoJSON by applying plan rules to districts
  - `buildColorExpression()` for MapLibre color expressions (ruleColor priority over interventionMixLabel)
  - Reuses existing hooks: `useOrgUnits`, `useInterventionCategories`, `useMultipleMetricValues`
  - Reuses `findMatchingDistrictIds` and `createInterventionMix` from existing codebase
  - Maps are non-interactive (`interactive={false}`) with no attribution
  - Renders at 4:3 aspect ratio centered on DRC (23.6, -2.9) at zoom 4
- Updated `comparison-sidebar.tsx` to replace map placeholder with `<MiniatureMap>` component
- Each plan card now shows the actual intervention coverage map for that plan's original rules
- All TypeScript and ESLint checks pass

### 2026-01-28: Verified edit detection and optimized miniature map rendering

- Verified badge updates in real-time: `isEdited` uses `useMemo` over `savedRules` and `originalRules`, so it recomputes immediately on any rule change
- Wrapped `MiniatureMap` component with `React.memo` to prevent unnecessary re-renders when the sidebar re-renders but the plan prop hasn't changed
- Data hooks (`useOrgUnits`, `useInterventionCategories`, `useMultipleMetricValues`) use React Query caching, so multiple miniature map instances share the same data without redundant fetches
- `planDistricts` computation is already memoized with `useMemo`
- All TypeScript checks pass

### 2026-01-28: Added slide animation for sidebar open/close

- Changed sidebar from conditional rendering (`if (!isOpen) return null`) to always-rendered with CSS transition
- Used `transition-[margin] duration-300 ease-in-out` with negative right margin (`-mr-80`) to slide the sidebar off-screen when closed
- Added `shrink-0` to prevent the sidebar from being compressed by flex layout
- Added `overflow-hidden` to the `<main>` container to prevent horizontal scroll when sidebar slides out
- Sidebar now smoothly slides in from the right when opened and slides out when closed
- All TypeScript and ESLint checks pass, build succeeds

### 2026-01-28: Ensure responsive behavior for comparison sidebar

- On screens below `lg` breakpoint (< 1024px), the comparison sidebar now overlays the map content using absolute positioning instead of pushing content aside
- Added `max-lg:absolute max-lg:right-0 max-lg:top-0 max-lg:z-10 max-lg:shadow-lg` to the sidebar container so it floats above content on smaller screens
- Added `relative` to the `<main>` container so the absolute sidebar positions correctly
- On larger screens (>= 1024px), the sidebar continues to push content as before
- All TypeScript checks pass
