# React Query Migration - Implementation Progress

## Phase 1: Setup Infrastructure
- [x] Install @tanstack/react-query package (v5.90.20)
- [x] Install @tanstack/react-query-devtools (dev dependency, v5.91.2)
- [x] Create /src/lib/query-client.ts with QueryClient configuration
- [x] Create /src/lib/query-keys.ts with query key factory
- [x] Create /src/app/providers.tsx with QueryClientProvider
- [x] Update /src/app/layout.tsx to use Providers

## Phase 2: Migrate Static Data Hooks
- [x] Migrate useOrgUnits hook
  - [x] Replace useEffect/useState with useQuery
  - [x] Preserve geoJson and provinces computed values
  - [x] Preserve updateDistricts callback functionality
  - [x] Test in plan page (build passed)
- [x] Migrate useInterventionCategories hook
  - [x] Replace useEffect/useState with useQuery
  - [x] Verify return type compatibility
  - [x] Test in plan page (build passed)
- [x] Migrate useMetricTypes hook
  - [x] Replace useEffect/useState with useQuery
  - [x] Preserve groupedByCategory computed value (using useMemo)
  - [x] Preserve addMetric callback with local state for client-side metrics
  - [x] Test in plan page and layers page (build passed)

## Phase 3: Migrate Parameterized Hooks
- [x] Migrate useMetricValues hook
  - [x] Replace useEffect/useState with useQuery
  - [x] Use enabled option for null metricTypeId
  - [x] Preserve valuesByOrgUnit, min, max computed values
  - [x] Configure staleTime: 5 minutes
  - [x] Test with build (passed)
- [x] Migrate useMultipleMetricValues hook
  - [x] Replace Promise.all with useQueries
  - [x] Preserve metricValuesByType Map structure (Record<number, Record<number, number>>)
  - [x] Uses same queryKeys.metricValues(id) as useMetricValues for cache sharing
  - [x] Individual error handling: first error returned, others continue
  - [x] Test with build (passed)

## Phase 4: Cleanup and Optimization
- [x] Remove unused imports from migrated hooks (verified: all imports are in use)
- [x] Configure staleTime per query type:
  - [x] orgUnits: Infinity
  - [x] intervention-categories: Infinity
  - [x] metric-types: Infinity
  - [x] metric-values: 5 minutes
- [x] Add error boundary component for query errors
  - [x] Created /src/components/query-error-boundary.tsx
  - [x] Uses QueryErrorResetBoundary from React Query
  - [x] Provides "Try again" button to reset and retry failed queries
- [x] Review and optimize gcTime settings
  - [x] Added gcTime: Infinity to useOrgUnits (static geographic data)
  - [x] Added gcTime: Infinity to useInterventionCategories (static reference data)
  - [x] Added gcTime: Infinity to useMetricTypes (static metadata)
  - [x] useMetricValues uses default gcTime (30 minutes) - appropriate for semi-static data

## Phase 5: Testing and Validation
- [ ] Verify request deduplication (Network tab)
  - [ ] Same metric requested by multiple components = 1 request
  - [ ] Navigate away and back = no refetch (within staleTime)
- [ ] Verify cache population (React Query DevTools)
  - [ ] All query keys visible
  - [ ] Data correctly cached
- [ ] Test error scenarios
  - [ ] Individual metric fetch failure
  - [ ] Network offline behavior
- [ ] Performance validation
  - [ ] Compare initial load time before/after
  - [ ] Verify no memory leaks

## Notes
- useOrgUnits migration uses hybrid approach: useQuery for fetching + useState for mutable GeoJSON data (required for updateDistricts callback)
- useMetricTypes migration uses hybrid approach: useQuery for fetching + useState for locally added metrics (required for addMetric callback)

## Issues Encountered
-

## Completion Date
- Phase 1: 2026-01-28
- Phase 2: 2026-01-28
- Phase 3: 2026-01-28
- Phase 4: 2026-01-28
- Phase 5:
- Full Migration:
